id: collared_lions_report
requirements:
  - name: ecoscope-workflows-core
    version: "0.17.0.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-ecoscope
    version: "0.17.0.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-custom
    version: "*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-lion-guardians
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/

workflow:
  #Set workflow details
  - name: Set Workflow Details
    id: workflow_details
    task: set_workflow_details

  #Enter time range 
  - name: Time Range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"
  
  #Set groupers
  - name: Set Groupers
    id: groupers
    task: set_groupers

  #connect to ER 
  - name: Data Source
    id: er_client_name
    task: set_er_connection

  # Set base maps
  - name: Base Maps
    id: base_map_defs
    task: set_custom_base_maps

  # Download amboseli group ranches and the collared lions templates
  - name: Download amboseli group ranches
    id: persist_ambo_gpkg
    task: download_file_and_persist
    partial:
      url: https://www.dropbox.com/scl/fi/phlc488gxqpcvr6ua3vk7/amboseli_group_ranch_boundaries.gpkg?rlkey=p5ztypwmj4ndjova9xe2ssiun&st=pknuicus&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false
      retries: 3
      unzip: false
  
  - name: Download collared lions cover page 
    id: persist_cover_page
    task: download_file_and_persist
    partial:
      url: https://www.dropbox.com/scl/fi/1cbilbjq8625gsd5bb45m/collared_lions_cover_page.docx?rlkey=j6aq1bjrrsiv0qj4bghwywe1d&st=eqttsiau&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false
      retries: 3
      unzip: false

  - name: Download collared subject page
    id: persist_indv_subject_page
    task: download_file_and_persist
    partial:
      url: https://www.dropbox.com/scl/fi/rdjej0c0dva7y8czw82de/collared_lion_subject_template.docx?rlkey=479h5pmpvjncgn314hd2r80yh&st=iuuc1o6t&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false
      retries: 3
      unzip: false

 #Load custom shapefiles
  - name : Load downloaded shapefiles
    id: load_local_shapefiles 
    task: load_geospatial_files
    partial:
      config: 
        path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}

  - name: Clean file keys from initially loaded geospatial files
    id: clean_local_geo_files
    task: clean_file_keys 
    partial: 
      file_dict: ${{ workflow.load_local_shapefiles.return }}

  # Create community conservancy map layers 
  - name: Create Map Layers
    id: create_custom_map_layers
    task: create_map_layers
    partial:
      file_dict: ${{ workflow.load_local_shapefiles.return }}
      style_config:
        styles:
          amboseli_group_ranch_boundaries: 
            stroked: true
            filled: false
            get_elevation: 50
            opacity: 0.55
            get_line_color: [105, 105, 105, 200]
            get_line_width: 3.5
        legend:
          label:
            - Group ranch boundaries
          color:
            - "#696969"

  - name: Select Key of Interest to annotate text layers on the map
    id: filter_aoi
    task: select_koi
    partial:
      file_dict: ${{ workflow.clean_local_geo_files.return }}
      key_value: amboseli_group_ranch_boundaries

  - name: Create text layer 
    id: custom_text_layer
    task: make_text_layer
    partial:
      txt_gdf: ${{ workflow.filter_aoi.return }}
      label_column: "R_NAME"
      fallback_columns:
        - name
        - title
      use_centroid: true 
      color: [0,0,0,255]
      size: 75
      font_family: Calibri
      font_weight: bold
      background: false
      background_color: null
      background_padding: null
      text_anchor: start
      alignment_baseline: bottom
      billboard: true
      pickable: true
      tooltip_columns:
        - label 
      target_crs: epsg:4326

  #Get subject group observations
  - name: Get Subject Group Observations from EarthRanger
    id: subject_obs
    task: get_subjectgroup_observations
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      raise_on_empty: false
      include_details: false
      include_subjectsource_details: false
  
  #Process relocations 
  - name: Transform Observations to Relocations
    id: subject_reloc
    task: process_relocations
    partial:
      observations: ${{ workflow.subject_obs.return }}
      relocs_columns:
        - groupby_col
        - fixtime
        - junk_status
        - geometry
        - extra__subject__name
        - extra__subject__subject_subtype
        - extra__subject__sex
      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  # Convert Relocs to Trajectories
  - name: Transform Relocations to Trajectories
    id: subject_traj
    task: relocations_to_trajectory
    partial:
      relocations: ${{ workflow.subject_reloc.return }}

  # Add temporal index
  - name: Add temporal index to Subject Trajectories
    id: traj_add_temporal_index
    task: add_temporal_index
    partial:
      df: ${{ workflow.subject_traj.return }}
      time_col: segment_start
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true
      format: mixed

  # Split subjects trajectories by group
  - name: Split Subject Trajectories by Group
    id: split_subject_traj_groups
    task: split_groups
    partial:
      df: ${{ workflow.traj_add_temporal_index.return }}
      groupers: ${{ workflow.groupers.return }}
  
  # Calculate Time Density
  - title: Time Density Map
    type: task-group
    description: These settings show a grid-based heatmap showing where subjects spent the most time.
    tasks:
      #calculate time density for individual subjects
      - name: null
        id: td
        task: calculate_elliptical_time_density
        partial:
          crs: ESRI:53042
          percentiles:
            - 50.000000
            - 60.000000
            - 70.000000
            - 80.000000
            - 90.000000
            - 95.000000
            - 99.000000
          nodata_value: nan
          band_count: 1
        mapvalues:
          argnames: trajectory_gdf
          argvalues: ${{ workflow.split_subject_traj_groups.return }}

        #time density colormap -adopting subject tracks approach for now 
      - name: Time Density Colormap
        id: td_colormap
        task: apply_color_map
        partial:
          input_column_name: percentile
          colormap: RdYlGn
          output_column_name: percentile_colormap
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.td.return }}
      
      # create polygon layer
      - name: Create map layer from Time Density
        id: td_map_layer
        task: create_geojson_layer
        skipif:
          conditions:
            - any_is_empty_df
            - any_dependency_skipped
        partial:
          layer_style:
            get_fill_color: percentile_colormap
            opacity: 0.45
            get_line_width: 0.75
            stroked: true
          legend:
            label_column: percentile
            color_column: percentile_colormap
          tooltip_columns:
            - percentile
        mapvalues:
          argnames: geodataframe
          argvalues: ${{ workflow.td_colormap.return }}
      
        # Combine layers ie static and grouped
      - name: Combine Map Layers
        id: combine_custom_map_layers
        task: merge_static_and_grouped_layers
        partial:
          static_layers: 
            - ${{ workflow.create_custom_map_layers.return }}
            - ${{ workflow.custom_text_layer.return }}
        mapvalues:
          argnames: grouped_layers
          argvalues: ${{ workflow.td_map_layer.return }}

      # Dynamically zoom map to layer of interest
      - name: zoom by view state
        id: zoom_view_state
        task: view_state_deck_gdf
        partial:
          pitch: 0
          bearing: 0
        mapvalues:
          argnames: gdf
          argvalues: ${{ workflow.td_colormap.return }}

        # Zip up tasks to pass them on the same mapvalues
      - name: Zip layers and viewstate
        id: zip_layers_view
        task: zip_grouped_by_key
        partial:
          left:  ${{ workflow.combine_custom_map_layers.return }}
          right: ${{ workflow.zoom_view_state.return }}

      - name: Draw Ecomap from Time Density
        id: td_ecomap
        task: draw_custom_map
        partial:
          tile_layers: ${{ workflow.base_map_defs.return }}
          static: false
          title: null
          max_zoom: 15
          legend_style:
            placement: "bottom-right"
            title: "ETD Metrics"
        mapvalues:
          argnames:
            - geo_layers
            - view_state
          argvalues: ${{ workflow.zip_layers_view.return }}

      #Persist ecomaps   
      - name: Persist Ecomap as Text
        id: td_ecomap_html_url
        task: persist_text
        partial:
          root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
        mapvalues:
          argnames: text
          argvalues: ${{ workflow.td_ecomap.return }}

      - name: Create Time Density Map Widget
        id: td_map_widget
        task: create_map_widget_single_view
        skipif:
          conditions:
            - never
        partial:
          title: Home Range Metrics
        map:
          argnames:
            - view
            - data
          argvalues: ${{ workflow.td_ecomap_html_url.return }}

      - name: Merge Time Density Map Widget Views
        id: td_grouped_map_widget
        task: merge_widget_views
        partial:
          widgets: ${{ workflow.td_map_widget.return }}
  
  - name: Generate summary table metrics for subjects
    id: summary_table
    task: summarize_df
    partial:
      groupby_cols:
        - extra__name
      summary_params: 
        - display_name: mean_speed
          aggregator: mean
          column: speed_kmhr

        - display_name: min_speed
          aggregator: min
          column: speed_kmhr

        - display_name: max_speed
          aggregator: max
          column: speed_kmhr
        
        - display_name: total_distance
          aggregator: sum 
          columnn: dist_meters
          original_unit: m
          new_unit: km 

      reset_index: true 
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_subject_traj_groups.return }}

  - name: Add total row on summary table
    id: add_total_events_row
    task: add_totals_row
    partial:
      label_col:
        - extra__name 
      label: Total
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.summary_table.return }}

  - name: Persist summary table
    id: persist_summary_table
    task: persist_df 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filetype: csv
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.add_total_events_row.return }}

  # convert html to png 
  - name: Convert collared subject html to png
    id: collared_html_png 
    task: html_to_png
    partial:
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 25000
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.td_ecomap_html_url.return }}

  # Retrieve unique subjects extracted from relocs
  - name: Unique subjects on relocs
    id: unique_subjects
    task: dataframe_column_nunique
    partial:
      df: ${{ workflow.subject_reloc.return }}
      column_name: extra__subject__name

  # Create context and persist subject report 
  - name: Create and persist cover page context
    id: create_cover_context
    task: create_cover_context_page
    partial:
      report_period: ${{ workflow.time_range.return}}
      prepared_by: Ecoscope
      count: ${{ workflow.unique_subjects.return }}
      template_path: ${{ workflow.persist_cover_page.return }}
      output_directory: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: cover_page.docx

  - name: Zip subject metrics and home range ecomap
    id: zip_metrics_etd
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.summary_table.return }}
      right: ${{ workflow.collared_html_png.return }}

  - name: Create individual subject context and persist
    id: subject_context_doc
    task: create_report_context
    partial:
      template_path: ${{ workflow.persist_indv_subject_page.return }}
      output_directory: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: null
      validate_images: true
      box_h_cm: 9.0
      box_w_cm: 15.0

    mapvalues: 
      argnames: 
        - subject_metrics
        - home_range_ecomap
      argvalues: ${{ workflow.zip_metrics_etd.return }}

  - name: Generate final report 
    id: generate_mapbook_report
    task: combine_docx_files
    partial:
      cover_page_path: ${{ workflow.create_cover_context.return }}
      output_directory: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      context_page_items: ${{ workflow.subject_context_doc.return }}
      filename: overall_report.docx

  # Metric summary widgets 
  - name: Calculate mean speed 
    id: calc_mean_speed
    task: dataframe_column_sum
    partial:
      column_name: mean_speed
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.summary_table.return }}

  - name: Round off mean speed to 2 decimal_places
    id: round_mean_speed
    task: round_off_values
    partial:
      dp: 2
    mapvalues:
      argnames: value
      argvalues: ${{ workflow.calc_mean_speed.return }}

  - name: Calculate min speed 
    id: calc_min_speed
    task: dataframe_column_sum
    partial:
      column_name: min_speed
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.summary_table.return }}

  - name: Round off min speed to 2 decimal_places
    id: round_min_speed
    task: round_off_values
    partial:
      dp: 2
    mapvalues:
      argnames: value
      argvalues: ${{ workflow.calc_min_speed.return }}
      
  - name: Calculate max speed 
    id: calc_max_speed
    task: dataframe_column_sum
    partial:
      column_name: max_speed
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.summary_table.return }}

  - name: Round off max speed to 2 decimal_places
    id: round_max_speed
    task: round_off_values
    partial:
      dp: 2
    mapvalues:
      argnames: value
      argvalues: ${{ workflow.calc_max_speed.return }}

  - name: Calculate total distance
    id: total_distance_covered
    task: dataframe_column_sum
    partial:
      column_name: total_distance
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.summary_table.return }}

  - name: Round off total distance to 2 decimal_places
    id: round_total_distance
    task: round_off_values
    partial:
      dp: 2
    mapvalues:
      argnames: value
      argvalues: ${{ workflow.total_distance_covered.return }}

  - name: Create Single Value Widgets for total mean speed Per Group
    id: total_mean_speed_widgets
    task: create_single_value_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Mean Speed 
      decimal_places: 1
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.round_mean_speed.return }}

  - name: Merge per group mean speed SV widgets
    id: total_mean_speed_sv_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.total_mean_speed_widgets.return }}

  - name: Create Single Value Widgets for total min speed Per Group
    id: total_min_speed_widgets
    task: create_single_value_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Min Speed 
      decimal_places: 1
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.round_min_speed.return }}

  - name: Merge per group min speed SV widgets
    id: total_min_speed_sv_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.total_min_speed_widgets.return }}

  - name: Create Single Value Widgets for total max speed Per Group
    id: total_max_speed_widgets
    task: create_single_value_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Max Speed 
      decimal_places: 1
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.round_max_speed.return }}

  - name: Merge per group max speed SV widgets
    id: total_max_speed_sv_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.total_max_speed_widgets.return }}

  - name: Create Single Value Widgets for total distance Per Group
    id: total_distance_widgets
    task: create_single_value_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Distance covered
      decimal_places: 1
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.round_total_distance.return }}

  - name: Merge per group total distance SV widgets
    id: total_distance_sv_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.total_distance_widgets.return }}

  - name: LG Dashboard
    id: lg_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets:
        - ${{ workflow.total_mean_speed_sv_widget.return }}
        - ${{ workflow.total_min_speed_sv_widget.return }}
        - ${{ workflow.total_max_speed_sv_widget.return }}
        - ${{ workflow.total_distance_sv_widget.return }}
        - ${{ workflow.td_grouped_map_widget.return }}

      time_range: ${{ workflow.time_range.return}}
      groupers: ${{ workflow.groupers.return }}