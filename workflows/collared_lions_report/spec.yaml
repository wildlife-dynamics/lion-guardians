id: collared_lions_report
requirements:
  - name: ecoscope-workflows-core
    version: "*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-custom
    version: "0.0.2.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-lion-guardians
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/


workflow:
  #Set workflow details
  - name: Set Workflow Details
    id: workflow_details
    task: set_workflow_details

  #Enter time range 
  - name: Time Range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"
  
  #Set groupers
  - name: Set Groupers
    id: groupers
    task: set_groupers

  #connect to ER 
  - name: Data Source
    id: er_client_name
    task: set_er_connection

  # Set base maps
  - name: Base Maps
    id: base_map_defs
    task: set_base_maps

  #Get subject group observations
  - name: Get Subject Group Observations from EarthRanger
    id: subject_obs
    task: get_subjectgroup_observations
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      raise_on_empty: false
      include_details: false
      include_subjectsource_details: false
  
  #Process relocations 
  - name: Transform Observations to Relocations
    id: subject_reloc
    task: process_relocations
    partial:
      observations: ${{ workflow.subject_obs.return }}
      relocs_columns:
        - groupby_col
        - fixtime
        - junk_status
        - geometry
        - extra__subject__name
        - extra__subject__subject_subtype
        - extra__subject__sex
      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  # Convert Relocs to Trajectories
  - name: Transform Relocations to Trajectories
    id: subject_traj
    task: relocations_to_trajectory
    partial:
      relocations: ${{ workflow.subject_reloc.return }}

  # Add temporal index
  - name: Add temporal index to Subject Trajectories
    id: traj_add_temporal_index
    task: add_temporal_index
    partial:
      df: ${{ workflow.subject_traj.return }}
      time_col: segment_start
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true
      format: mixed

  # Split subjects trajectories by group
  - name: Split Subject Trajectories by Group
    id: split_subject_traj_groups
    task: split_groups
    partial:
      df: ${{ workflow.traj_add_temporal_index.return }}
      groupers: ${{ workflow.groupers.return }}
  
  #Load custom shapefiles
  - name : Load local map files
    id: load_local_shapefiles 
    task: load_map_files

  - name: Create Map Layers
    id: create_custom_map_layers
    task: create_map_layers
    partial:
      file_dict: ${{ workflow.load_local_shapefiles.return }}

  # Calculate Time Density
  - title: Time Density Map
    type: task-group
    description: These settings show a grid-based heatmap showing where subjects spent the most time.
    tasks:
      #calculate time density for individual subjects
      - name: null
        id: td
        task: calculate_elliptical_time_density
        partial:
          crs: ESRI:53042
          percentiles:
            - 50.000000
            - 60.000000
            - 70.000000
            - 80.000000
            - 90.000000
            - 95.000000
            - 99.000000
          nodata_value: nan
          band_count: 1
        mapvalues:
          argnames: trajectory_gdf
          argvalues: ${{ workflow.split_subject_traj_groups.return }}

        #time density colormap -adopting subject tracks approach for now 
      - name: Time Density Colormap
        id: td_colormap
        task: apply_color_map
        partial:
          input_column_name: percentile
          colormap: RdYlGn
          output_column_name: percentile_colormap
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.td.return }}
      
      # create polygon layer
      - name: Create map layer from Time Density
        id: td_map_layer
        task: create_polygon_layer
        skipif:
          conditions:
            - any_is_empty_df
            - any_dependency_skipped
        partial:
          layer_style:
            fill_color_column: percentile_colormap
            opacity: 0.45
          legend:
            label_column: percentile
            color_column: percentile_colormap
          tooltip_columns:
            - percentile
        mapvalues:
          argnames: geodataframe
          argvalues: ${{ workflow.td_colormap.return }}
      
        # Combine layers ie static and grouped
      - name: Combine Map Layers
        id: combine_custom_map_layers
        task: combine_map_layers
        partial:
          static_layers: ${{ workflow.create_custom_map_layers.return }}
        mapvalues:
          argnames: grouped_layers
          argvalues: ${{ workflow.td_map_layer.return }}

      # Dynamically zoom map to layer of interest
      - name: zoom by view state
        id: zoom_view_state
        task: create_view_state_from_gdf
        partial:
          pitch: 0
          bearing: 0
        mapvalues:
          argnames: gdf
          argvalues: ${{ workflow.td_colormap.return }}

        # Zip up tasks to pass them on the same mapvalues
      - name: Zip layers and viewstate
        id: zip_layers_view
        task: zip_grouped_by_key
        partial:
          left:  ${{ workflow.combine_custom_map_layers.return }}
          right: ${{ workflow.zoom_view_state.return }}

      - name: Draw Ecomap from Time Density
        id: td_ecomap
        task: draw_ecomap
        partial:
          tile_layers: ${{ workflow.base_map_defs.return }}
          north_arrow_style:
            placement: top-left 
          legend_style:  
            placement: bottom-right 
            title: Home Range Metrics
          static: false
          title: null
          max_zoom: 20
        mapvalues:
          argnames:
            - geo_layers
            - view_state
          argvalues: ${{ workflow.zip_layers_view.return }}

      #Persist ecomaps   
      - name: Persist Ecomap as Text
        id: td_ecomap_html_url
        task: persist_text
        partial:
          root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
        mapvalues:
          argnames: text
          argvalues: ${{ workflow.td_ecomap.return }}

      - name: Create Time Density Map Widget
        id: td_map_widget
        task: create_map_widget_single_view
        skipif:
          conditions:
            - never
        partial:
          title: Collared Lions Home Range Ecomap
        map:
          argnames:
            - view
            - data
          argvalues: ${{ workflow.td_ecomap_html_url.return }}

      - name: Merge Time Density Map Widget Views
        id: td_grouped_map_widget
        task: merge_widget_views
        partial:
          widgets: ${{ workflow.td_map_widget.return }}
  
  - name: LG Dashboard
    id: lg_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets:
        - ${{ workflow.td_grouped_map_widget.return }}
      time_range: ${{ workflow.time_range.return}}
      groupers: ${{ workflow.groupers.return }}

      