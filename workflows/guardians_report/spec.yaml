id: guardians_report
requirements:
  - name: ecoscope-workflows-core
    version: "*"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  
  - name: ecoscope-workflows-ext-custom
    version: "0.0.3.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/
  
  - name: ecoscope-workflows-ext-lion-guardians
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/

workflow:
  # Set workflow details
  - name: Set Workflow Details
    id: workflow_details
    task: set_workflow_details

  # Set time range
  - name: Time Range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"

  # Set groupers
  - name: Set Groupers
    id: groupers
    task: set_groupers

  # Connect to ER
  - name: Data Source
    id: er_client_name
    task: set_er_connection
  
  # Set base maps
  - name: Base Maps
    id: base_map_defs
    task: set_base_maps

  # Load custom shapefiles
  - name : Load local map files
    id: load_local_shapefiles 
    task: load_map_files

  # Create map layers
  - name: Create Map Layers
    id: create_custom_map_layers
    task: create_map_layers
    partial:
      file_dict: ${{ workflow.load_local_shapefiles.return }}

  #Get subject group observations
  - name: Get Subject Group Observations from EarthRanger
    id: subject_group_observations
    task: get_subjectgroup_observations
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      raise_on_empty: false
      include_details: false
      include_subjectsource_details: false
  
  #Process relocations 
  - name: Transform Observations to Relocations
    id: subject_relocations
    task: process_relocations
    partial:
      observations: ${{ workflow.subject_group_observations.return }}
      relocs_columns:
        - groupby_col
        - fixtime
        - junk_status
        - geometry
        - extra__subject__name
        - extra__subject__subject_subtype
        - extra__subject__sex
      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  # Convert Relocs to Trajectories
  - name: Transform Relocations to Trajectories
    id: subject_trajectory
    task: relocations_to_trajectory
    partial:
      relocations: ${{ workflow.subject_relocations.return }}

  # Add temporal index
  - name: Add temporal index to Subject Trajectories
    id: traj_add_temporal_index
    task: add_temporal_index
    partial:
      df: ${{ workflow.subject_trajectory.return }}
      time_col: segment_start
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true
      format: mixed

  # Classify trajectories by speed
  - name: Classify Trajectories By Speed
    id: classify_trajectory_speed
    task: apply_classification
    partial:
      df: ${{ workflow.traj_add_temporal_index.return }}
      input_column_name: speed_kmhr
      output_column_name: speed_bins
      classification_options:
        scheme: equal_interval
        k: 6
      label_options:
        label_ranges: false
        label_decimals: 1
  
  # Split trajectories by group
  - name: Split Subject Trajectories by Group
    id: split_subject_traj_groups
    task: split_groups
    partial:
      df: ${{ workflow.classify_trajectory_speed.return }}
      groupers: ${{ workflow.groupers.return }}
    
  - name: Sort Trajetories By Classification
    id: sort_trajectories_speed
    task: sort_values
    partial:
      column_name: speed_bins
      ascending: true
      na_position: last
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_subject_traj_groups.return }}

  - name: Apply Color to Trajectories By Speed
    id: colormap_traj_speed
    task: apply_color_map
    partial:
      input_column_name: speed_bins
      output_column_name: speed_bins_colormap
      colormap:
        - '#1a9850'
        - '#91cf60'
        - '#d9ef8b'
        - '#fee08b'
        - '#fc8d59'
        - '#d73027'
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.sort_trajectories_speed.return }}

  - name: Format Speedmap bins for legend
    id: speed_bin_legend_with_unit
    task: map_values_with_unit
    partial:
      input_column_name: speed_bins
      output_column_name: speed_bins_formatted
      original_unit: km/h
      new_unit: km/h
      decimal_places: 1
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.colormap_traj_speed.return }}

  - name: Format speed values for display
    id: speed_val_with_unit
    task: map_values_with_unit
    partial:
      input_column_name: speed_kmhr
      output_column_name: speed_kmhr
      original_unit: km/h
      new_unit: km/h
      decimal_places: 1
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.speed_bin_legend_with_unit.return }}
  
  - name: Rename columns for map tooltip display
    id: rename_speed_display_columns
    task: map_columns
    partial:
      drop_columns: []
      retain_columns: []
      rename_columns:
        segment_start: Start
        timespan_seconds: Duration (s)
        speed_kmhr: Speed (kph)
        extra__name: Subject Name
        extra__sex: Subject Sex
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.speed_val_with_unit.return }}

  - name: Create map layer for each trajectory group
    id: traj_map_layers
    task: create_polyline_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        color_column: speed_bins_colormap
      legend:
        label_column: speed_bins_formatted
        color_column: speed_bins_colormap
      tooltip_columns:
        - Start
        - Duration (s)
        - Speed (kph)
        - Nighttime
        - Subject Name
        - Subject Sex
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.rename_speed_display_columns.return }}

  # Summary table 
  - name: Subject summary table 
    id: summary_trajectory_table
    task: summarize_df
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_subject_traj_groups.return }}
    
    partial:
      groupby_cols:
        - extra__name 
      summary_params:
        - display_name: "Total Distance"
          aggregator: "sum"
          column: "dist_meters"
          original_unit: "m"
          new_unit: "km"
          decimal_places: 2
  
    # Persist summary table
  - name: Persist Summary table
    id: save_summary_table
    task: persist_df
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.summary_trajectory_table.return }}
    partial:
      filetype: "csv"
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}

  # Combine layers
  - name: Combine Map Layers
    id: combine_custom_map_layers
    task: combine_map_layers
    partial:
      static_layers: ${{ workflow.create_custom_map_layers.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.traj_map_layers.return }}

  # Dynamically zoom map to layer of interest
  - name: zoom by view state
    id: zoom_view_state
    task: create_view_state_from_gdf
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.rename_speed_display_columns.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip layers and viewstate
    id: zip_layers_view
    task: zip_grouped_by_key
    partial:
      left:  ${{ workflow.combine_custom_map_layers.return }}
      right: ${{ workflow.zoom_view_state.return }}

  # Draw ecomap using unified layer list
  - name: Draw Combined Ecomap
    id: draw_combined_ecomap
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.base_map_defs.return }}
      north_arrow_style:
        placement: top-left 
      legend_style:  
        placement: bottom-right 
        title: Speeds(Km/h)
      static: false
      title: null
      max_zoom: 20
    mapvalues:
      argnames: 
        - geo_layers
        - view_state
      argvalues:  ${{ workflow.zip_layers_view.return }}

  # Persist ecomap
  - name: Persist ecomap as text
    id: ecomap_url
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.draw_combined_ecomap.return }}

  # Create Speedmap Widget 
  - name: Create SpeedMap Widget
    id: speed_map_widget
    task: create_map_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Speed Map 
    
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.ecomap_url.return }}

  #Merge Speedmap Widgets
  - name: Merge Speedmap Widget Views
    id: td_grouped_map_widget
    task: merge_widget_views
    partial: 
      widgets: ${{ workflow.speed_map_widget.return }}
  
  - name: LG Dashboard
    id: lg_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets:
        - ${{ workflow.td_grouped_map_widget.return }}
      time_range: ${{ workflow.time_range.return}}
      groupers: ${{ workflow.groupers.return }}